REPORT zr_clear_doc.

TYPES: BEGIN OF ty_exl,
         vendor       TYPE string,
         clear_date   TYPE string,
         period       TYPE string,
         comp_code    TYPE string,
         gl_indicator TYPE string,
         doc1         TYPE string,
         doc2         TYPE string,
         text         TYPE string,
       END OF ty_exl.

DATA : gt_exl  TYPE TABLE OF ty_exl,
       gs_exl  TYPE          ty_exl,
       gt_item TYPE TABLE OF ty_exl,
       gs_item TYPE          ty_exl.

DATA: ls_bdcdata TYPE bdcdata,
      lt_bdcdata TYPE TABLE OF bdcdata.

TYPES: BEGIN OF ty_alv,
         vendor     TYPE string,
         clear_date TYPE string,
         doc1       TYPE string,
         doc2       TYPE string,
         clear_doc TYPE string,
         status     TYPE string,
       END OF ty_alv.

DATA: gt_final TYPE TABLE OF ty_alv,
      gs_final TYPE ty_alv.

DATA : lt_fieldcat TYPE slis_t_fieldcat_alv,
       ls_fieldcat TYPE slis_fieldcat_alv.

DATA : gt_type TYPE truxs_t_text_data,
       lv_msg  TYPE string.

SELECTION-SCREEN: BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.

PARAMETERS: rb_dwnld RADIOBUTTON GROUP rg1 DEFAULT 'X' USER-COMMAND uc1,
            rb_upld  RADIOBUTTON GROUP rg1.

SELECTION-SCREEN: END OF BLOCK b1.

SELECTION-SCREEN: BEGIN OF BLOCK b2 WITH FRAME.

PARAMETERS: p_file TYPE rlgrap-filename MODIF ID mod.

SELECTION-SCREEN: END OF BLOCK b2.

AT SELECTION-SCREEN OUTPUT.

  LOOP AT SCREEN.
    IF rb_upld = 'X'.
      IF screen-group1 = 'MOD'.
        screen-active = 1.  " Visible and active
      ENDIF.
    ELSE.
      IF screen-group1 = 'MOD'.
        screen-active = 0.  " Hidden
      ENDIF.
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file.

  CALL FUNCTION 'F4_FILENAME'     "This FM gives the pop-up of the file explorer and returns the path of the chosen file.
    EXPORTING
      program_name  = syst-cprog
      dynpro_number = syst-dynnr
      field_name    = ' '
    IMPORTING
      file_name     = p_file.


START-OF-SELECTION.

  CASE abap_true.

    WHEN rb_dwnld.
      PERFORM download_format.

    WHEN rb_upld.
      PERFORM upload_data.
      PERFORM clear_doc.
      PERFORM display_alv.

  ENDCASE.


FORM download_format.

  DATA : gs_download TYPE ty_exl,
         l_file_w    TYPE string,
         gt_download TYPE STANDARD TABLE OF ty_exl.


  CALL METHOD cl_gui_frontend_services=>directory_browse
    CHANGING
      selected_folder      = l_file_w
    EXCEPTIONS
      cntl_error           = 1
      error_no_gui         = 2
      not_supported_by_gui = 3
      OTHERS               = 4.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

  CONCATENATE l_file_w '\Clear_Doc' sy-datum '.xls' INTO l_file_w.

  gs_download-vendor = 'Vendor'.
  gs_download-clear_date = 'Clearing Date'.
  gs_download-period = 'Period'.
  gs_download-comp_code = 'Company Code'.
  gs_download-gl_indicator = 'G/L Indicators'.
  gs_download-doc1 = 'Document No. 1'.
  gs_download-doc2 = 'Document No. 2'.
  gs_download-text = 'Text'.
  APPEND gs_download TO gt_download.

  CALL METHOD cl_gui_frontend_services=>gui_download
    EXPORTING
      filename                = l_file_w
      write_field_separator   = 'X'
    CHANGING
      data_tab                = gt_download
    EXCEPTIONS
      file_write_error        = 1
      no_batch                = 2
      gui_refuse_filetransfer = 3
      invalid_type            = 4
      no_authority            = 5
      unknown_error           = 6
      header_not_allowed      = 7
      separator_not_allowed   = 8
      filesize_not_allowed    = 9
      header_too_long         = 10
      dp_error_create         = 11
      dp_error_send           = 12
      dp_error_write          = 13
      unknown_dp_error        = 14
      access_denied           = 15
      dp_out_of_memory        = 16
      disk_full               = 17
      dp_timeout              = 18
      file_not_found          = 19
      dataprovider_exception  = 20
      control_flush_error     = 21
      not_supported_by_gui    = 22
      error_no_gui            = 23
      OTHERS                  = 24.
  IF sy-subrc EQ 0.
    MESSAGE 'File Downloaded Successfully' TYPE 'S' DISPLAY LIKE 'S'.
    LEAVE LIST-PROCESSING.
  ENDIF.


ENDFORM.


FORM upload_data .

  CALL FUNCTION 'TEXT_CONVERT_XLS_TO_SAP'
    EXPORTING
      i_field_seperator    = ' '
      i_line_header        = 'X'
      i_tab_raw_data       = gt_type
      i_filename           = p_file
    TABLES
      i_tab_converted_data = gt_exl
    EXCEPTIONS
      conversion_failed    = 1
      OTHERS               = 2.
  IF sy-subrc <> 0.
    MESSAGE 'File not converted' TYPE 'E'.
  ENDIF.

  IF gt_exl IS NOT INITIAL.
    SORT gt_exl BY vendor.
    gt_item = gt_exl.
    DELETE ADJACENT DUPLICATES FROM gt_exl COMPARING vendor.
  ENDIF.

ENDFORM.


FORM clear_doc .

  DATA: ls_messtab TYPE bdcmsgcoll,
        lt_messtab TYPE TABLE OF bdcmsgcoll,
        lc_n(1)    TYPE c VALUE 'N',
        lc_a(1)    TYPE c VALUE 'A',
        lc_dot(1)  TYPE c VALUE '.'.

  LOOP AT gt_exl INTO gs_exl.

*    PERFORM bdc_dynpro      USING 'SAPMF05A' '0131'.
**    PERFORM bdc_field       USING 'BDC_OKCODE'
**                                  '/ERW'.
*    PERFORM bdc_field       USING 'BDC_CURSOR'
*                                  'RF05A-AGUMS'.
*    PERFORM bdc_dynpro      USING 'SAPLSPO1' '0200'.
*    PERFORM bdc_field       USING 'BDC_OKCODE'
*                                  '=YES'.
*  PERFORM bdc_transaction USING 'F-44'.
*    REFRESH: lt_messtab.
*    CALL TRANSACTION 'F-44' USING lt_bdcdata
*                     MODE   lc_n
*                     UPDATE lc_a
*                     MESSAGES INTO lt_messtab.

    PERFORM bdc_dynpro      USING 'SAPMF05A' '0131'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RF05A-XPOS1(03)'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00'.
    PERFORM bdc_field       USING 'RF05A-AGKON'
                                  gs_exl-vendor."'600000002'.  "Account No
    PERFORM bdc_field       USING 'BKPF-BUDAT'
                                  gs_exl-clear_date."'09.12.2025'. "Clearing Date
    PERFORM bdc_field       USING 'BKPF-MONAT'
                                  gs_exl-period."'9'.          "Period
    PERFORM bdc_field       USING 'BKPF-BUKRS'
                                  gs_exl-comp_code."'7010'.       "Company Code
    PERFORM bdc_field       USING 'BKPF-WAERS'
                                  'INR'.
    PERFORM bdc_field       USING 'RF05A-AGUMS'
                                  gs_exl-gl_indicator."'A'.          "Special G/L Indicators
    PERFORM bdc_field       USING 'RF05A-XNOPS'
                                  'X'.
    PERFORM bdc_field       USING 'RF05A-XPOS1(01)'
                                  ''.
    PERFORM bdc_field       USING 'RF05A-XPOS1(03)'
                                  'X'.
    PERFORM bdc_dynpro      USING 'SAPMF05A' '0731'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RF05A-SEL01(02)'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00'.
    PERFORM bdc_field       USING 'RF05A-SEL01(01)'
                                  gs_exl-doc1."'1900000002'.     "Doc 1
    PERFORM bdc_field       USING 'RF05A-SEL01(02)' "Doc 2
                                  gs_exl-doc2."'1700000000'.
    PERFORM bdc_dynpro      USING 'SAPMF05A' '0731'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RF05A-SEL01(01)'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=PA'.
    PERFORM bdc_dynpro      USING 'SAPDF05X' '3100'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=REST'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'DF05B-PSSKT(01)'.
    PERFORM bdc_dynpro      USING 'SAPDF05X' '3100'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=PI'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'DF05B-PSDIF(01)'.
    PERFORM bdc_dynpro      USING 'SAPDF05X' '3100'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BS'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'DF05B-PSDIF(01)'.
    PERFORM bdc_dynpro      USING 'SAPMF05A' '0700'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RF05A-AZEI1(01)'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=PI'.
    PERFORM bdc_dynpro      USING 'SAPMF05A' '0302'.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BSEG-SGTXT'.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BU'.
    PERFORM bdc_field       USING 'BSEG-SGTXT'
                                  gs_exl-text."'TEST MEZA'.  "Text
*  PERFORM bdc_transaction USING 'F-44'.
*    REFRESH: lt_messtab.
    CALL TRANSACTION 'F-44' USING lt_bdcdata
                     MODE   lc_n
                     UPDATE lc_a
                     MESSAGES INTO lt_messtab.

    IF line_exists( lt_messtab[ msgid = 'F5' msgnr = '312' ] ).

      DATA(lv_clr_doc) = lt_messtab[ msgid = 'F5' msgnr = '312' ]-msgv1.

      READ TABLE lt_messtab ASSIGNING FIELD-SYMBOL(<fs_msg>) WITH KEY msgid = 'F5' msgnr = '312' .

      MOVE-CORRESPONDING gs_exl to gs_final.
      gs_final-status = gs_final-status = 'Document Cleared'.
      gs_final-clear_doc = lv_clr_doc.

      APPEND gs_final TO gt_final.

    ELSE.

      MOVE-CORRESPONDING gs_exl to gs_final.
      gs_final-status = 'Document Not Cleared'.

      APPEND gs_final TO gt_final.


    ENDIF.

  ENDLOOP.

ENDFORM.

FORM bdc_dynpro USING program dynpro.
  CLEAR ls_bdcdata.
  ls_bdcdata-program  = program.
  ls_bdcdata-dynpro   = dynpro.
  ls_bdcdata-dynbegin = 'X'.
  APPEND ls_bdcdata TO lt_bdcdata.
ENDFORM.

FORM bdc_field USING fnam fval.
  CLEAR ls_bdcdata.
  ls_bdcdata-fnam = fnam.
  ls_bdcdata-fval = fval.
  APPEND ls_bdcdata TO lt_bdcdata.
ENDFORM.


FORM display_alv .

  ls_fieldcat-col_pos = '1'.
  ls_fieldcat-fieldname = 'vendor'.
  ls_fieldcat-tabname = 'gt_final'. "Internal Table containg all the data
  ls_fieldcat-seltext_l = 'Vendor'.
  APPEND ls_fieldcat TO lt_fieldcat.
  CLEAR ls_fieldcat.

  ls_fieldcat-col_pos = '2'.
  ls_fieldcat-fieldname = 'clear_date'.
  ls_fieldcat-tabname = 'gt_final'. "Internal Table containg all the data
  ls_fieldcat-seltext_l = 'Clearing Date'.
  APPEND ls_fieldcat TO lt_fieldcat.
  CLEAR ls_fieldcat.

  ls_fieldcat-col_pos = '3'.
  ls_fieldcat-fieldname = 'doc1'.
  ls_fieldcat-tabname = 'gt_final'. "Internal Table containg all the data
  ls_fieldcat-seltext_l = 'Docuent No. 1'.
  APPEND ls_fieldcat TO lt_fieldcat.
  CLEAR ls_fieldcat.

  ls_fieldcat-col_pos = '4'.
  ls_fieldcat-fieldname = 'doc2'.
  ls_fieldcat-tabname = 'gt_final'. "Internal Table containg all the data
  ls_fieldcat-seltext_l = 'Docuent No. 2'.
  APPEND ls_fieldcat TO lt_fieldcat.
  CLEAR ls_fieldcat.

  ls_fieldcat-col_pos = '5'.
  ls_fieldcat-fieldname = 'clear_doc'.
  ls_fieldcat-tabname = 'gt_final'. "Internal Table containg all the data
  ls_fieldcat-seltext_l = 'Clearing Doc'.
  APPEND ls_fieldcat TO lt_fieldcat.
  CLEAR ls_fieldcat.

    ls_fieldcat-col_pos = '6'.
  ls_fieldcat-fieldname = 'status'.
  ls_fieldcat-tabname = 'gt_final'. "Internal Table containg all the data
  ls_fieldcat-seltext_l = 'Status'.
  APPEND ls_fieldcat TO lt_fieldcat.
  CLEAR ls_fieldcat.


  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
*     I_INTERFACE_CHECK                 = ' '
*     I_BYPASSING_BUFFER                = ' '
*     I_BUFFER_ACTIVE                   = ' '
*     I_CALLBACK_PROGRAM                = ' '
*     I_CALLBACK_PF_STATUS_SET          = ' '
*     I_CALLBACK_USER_COMMAND           = ' '
*     I_CALLBACK_TOP_OF_PAGE            = ' '
*     I_CALLBACK_HTML_TOP_OF_PAGE       = ' '
*     I_CALLBACK_HTML_END_OF_LIST       = ' '
*     I_STRUCTURE_NAME                  =
*     I_BACKGROUND_ID                   = ' '
*     I_GRID_TITLE  =
*     I_GRID_SETTINGS                   =
*     IS_LAYOUT     =
      it_fieldcat   = lt_fieldcat
*     IT_EXCLUDING  =
*     IT_SPECIAL_GROUPS                 =
*     IT_SORT       =
*     IT_FILTER     =
*     IS_SEL_HIDE   =
*     I_DEFAULT     = 'X'
*     I_SAVE        = ' '
*     IS_VARIANT    =
*     IT_EVENTS     =
*     IT_EVENT_EXIT =
*     IS_PRINT      =
*     IS_REPREP_ID  =
*     I_SCREEN_START_COLUMN             = 0
*     I_SCREEN_START_LINE               = 0
*     I_SCREEN_END_COLUMN               = 0
*     I_SCREEN_END_LINE                 = 0
*     I_HTML_HEIGHT_TOP                 = 0
*     I_HTML_HEIGHT_END                 = 0
*     IT_ALV_GRAPHICS                   =
*     IT_HYPERLINK  =
*     IT_ADD_FIELDCAT                   =
*     IT_EXCEPT_QINFO                   =
*     IR_SALV_FULLSCREEN_ADAPTER        =
* IMPORTING
*     E_EXIT_CAUSED_BY_CALLER           =
*     ES_EXIT_CAUSED_BY_USER            =
    TABLES
      t_outtab      = gt_final
    EXCEPTIONS
      program_error = 1
      OTHERS        = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
