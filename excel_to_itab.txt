REPORT z31_file_handling.

TYPES: BEGIN OF str_data,
         carrid(10) TYPE c,
         connid(10) TYPE c,
         fldate(10) TYPE c,
         price(10)  TYPE c,
       END OF str_data.
DATA: lt_final TYPE TABLE OF str_data,
      ls_final TYPE str_data.

PARAMETERS: p_file TYPE localfile.

DATA lt_data TYPE TABLE OF alsmex_tabline.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file.
  CALL FUNCTION 'F4_FILENAME'
    EXPORTING
      program_name  = syst-cprog
      dynpro_number = syst-dynnr
      field_name    = ' '
    IMPORTING
      file_name     = p_file.


START-OF-SELECTION.
  CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE'
    EXPORTING
      filename                = p_file
      i_begin_col             = 1
      i_begin_row             = 2
      i_end_col               = 9999
      i_end_row               = 9999
    TABLES
      intern                  = lt_data
    EXCEPTIONS
      inconsistent_parameters = 1
      upload_ole              = 2
      OTHERS                  = 3.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

  LOOP AT lt_data INTO DATA(ls_data).
    CASE ls_data-col.
      WHEN 1.
        ls_final-carrid = ls_data-value.
      WHEN 2.
        ls_final-connid = ls_data-value.
      WHEN 3.
        ls_final-fldate = | { ls_data-value+6(4) }{ ls_data-value+3(2) }{ ls_data-value+0(2) }|.
      WHEN 4.
        ls_final-price = ls_data-value.
    ENDCASE.

    READ TABLE lt_final INDEX ls_data-row TRANSPORTING NO FIELDS.
    IF sy-subrc = 0.
      MODIFY lt_final FROM ls_final INDEX ls_data-row.
    ELSE.
      APPEND ls_final TO lt_final.
    ENDIF

  ENDLOOP.

  cl_demo_output=>display( lt_final ).


****************************************************************
TYPES: BEGIN OF ty_exl,
         assetmaino TYPE string,
         tran_dat   TYPE string,
         text       TYPE string,
       END OF ty_exl.

DATA: gt_exl     TYPE TABLE OF ty_exl,
      gs_input   TYPE ty_exl.

DATA: l_file_w      TYPE string,
        lt_excel_data TYPE TABLE OF alsmex_tabline,
        it_index      TYPE i,
        col_start     TYPE i VALUE 1,
        row_start     TYPE i VALUE 2,
        col_end       TYPE i VALUE 256,
        row_end       TYPE i VALUE 65000,
        lv_timestamp  TYPE timestamp,
        lv_tstr       TYPE string.

CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE'
    EXPORTING
      filename                = p_file
      i_begin_col             = col_start
      i_begin_row             = row_start
      i_end_col               = col_end
      i_end_row               = row_end
    TABLES
      intern                  = lt_excel_data
    EXCEPTIONS
      inconsistent_parameters = 1
      upload_ole              = 2
      OTHERS                  = 3.
  IF sy-subrc NE 0.
    WRITE : / 'File Error'.
    EXIT.
  ENDIF.

  LOOP AT lt_excel_data INTO DATA(ls_excel).
    TRANSLATE ls_excel TO UPPER CASE .
    MOVE ls_excel-col TO it_index.
    ASSIGN COMPONENT it_index OF STRUCTURE gs_input TO FIELD-SYMBOL(<fs>) .
    MOVE ls_excel-value TO <fs>.
    AT END OF row.
      APPEND gs_input TO gt_exl.
      CLEAR gs_input.
    ENDAT.
  ENDLOOP.

